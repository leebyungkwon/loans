<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.loanscrefia.front.search.repository.SearchRepository">
   	
   	<!-- 모집인 조회 : 개인(결제) -->
   	<select id="selectPayIndvUserInfo" parameterType="search" resultType="search">
  		SELECT
   			 TLM.MASTER_SEQ
   			,TLM.PL_M_Z_ID
   		FROM TB_LC_MAS01 TLM
		WHERE TLM.PL_CLASS		= '1' 				-- 개인
		AND TLM.COM_CODE 		= #{comCode} 
		AND TLM.PL_M_NAME 		= #{plMName}
		AND TLM.PL_CELLPHONE 	= #{plCellphone}
		AND TLM.PL_REG_STAT 	= '2' 				-- 모집인상태 : 승인완료
		AND TLM.PL_STAT 		= '9' 				-- 처리상태 : 완료
   	</select>
   	
   	<!-- 모집인 조회 : 법인(결제) -->
   	<select id="selectPayCorpUserInfo" parameterType="search" resultType="search">
   		SELECT
   			TLM.MASTER_SEQ
   		FROM TB_LC_MAS01 TLM
		WHERE TLM.PL_CLASS		= '2' 				-- 법인 
		AND TLM.COM_CODE 		= #{comCode}
		AND TLM.PL_MERCHANT_NO 	= #{plMerchantNo}
		AND TLM.PL_CEO_NAME 	= #{plCeoName}
		AND TLM.PL_REG_STAT 	= '2' 				-- 모집인상태 : 승인완료
		AND TLM.PL_STAT 		= '9' 				-- 처리상태 : 완료
   	</select>
   	
   	<!-- 모집인 조회 : 개인 -->
   	<select id="selectIndvUserInfo" parameterType="search" resultType="search">
  		SELECT
   			 TLM.MASTER_SEQ
   		FROM TB_LC_MAS01 TLM
		WHERE TLM.PL_CLASS		= '1' 				-- 개인
		<if test="masterToId != null and masterToId != ''">
		AND TLM.MASTER_TO_ID	= #{masterToId}
		</if>
		<if test="conNum != null and conNum != ''">
		AND TLM.CON_NUM			= #{conNum}
		</if>
		AND TLM.PL_CELLPHONE 	= #{plCellphone}
		AND TLM.PL_REG_STAT 	= '3' 				-- 모집인상태 : 자격취득
		AND TLM.PL_STAT 		= '9' 				-- 처리상태 : 완료
   	</select>
   	
   	<!-- 모집인 조회 : 법인 -->
   	<select id="selectCorpUserInfo" parameterType="search" resultType="search">
   		SELECT
   			TLM.MASTER_SEQ
   		FROM TB_LC_MAS01 TLM
		WHERE TLM.PL_CLASS			= '2' 				-- 법인 
		<if test="masterToId != null and masterToId != ''">
		AND TLM.MASTER_TO_ID		= #{masterToId}
		</if>
		<if test="conNum != null and conNum != ''">
		AND TLM.CON_NUM				= #{conNum}
		</if>
		AND TLM.PL_MERCHANT_NAME 	= #{plMerchantName}
		AND TLM.PL_REG_STAT 		= '3' 				-- 모집인상태 : 자격취득
		AND TLM.PL_STAT 			= '9' 				-- 처리상태 : 완료
   	</select>
   	
   	<!-- 모집인 상세 -->
	<select id="selectSearchUserInfo" parameterType="search" resultType="search">
		SELECT
			 TLM.MASTER_SEQ
			,TLM.MASTER_TO_ID
			,TLM.COM_CODE
			,FN_COM_CODE(TLM.COM_CODE) AS COM_CODE_NM
			<!-- ,(SELECT TLP.COMP_PHONE_NO FROM TB_LC_COMPANY TLP WHERE TLP.COM_CODE = TLM.COM_CODE AND TLP.DEL_YN = 'N') AS COMP_TEL -->
			,TLM.MEMBER_SEQ
			,FN_MEMBER_NAME(TLM.MEMBER_SEQ) AS MEMBER_NM
			,TLM.PL_CLASS
			,FN_CD_DTL('CLS001',TLM.PL_CLASS) AS PL_CLASS_NM
			,TLM.CORP_USER_YN
			,TLM.CAREER_TYP
			,FN_CD_DTL('CAR001',TLM.CAREER_TYP) AS CAREER_TYP_NM
			,TLM.PL_PRODUCT
			,FN_CD_DTL('PRD001',TLM.PL_PRODUCT) AS PL_PRODUCT_NM
			,TLM.PL_REG_STAT
			,FN_CD_DTL('REG001',TLM.PL_REG_STAT) AS PL_REG_STAT_NM
			,TLM.PL_STAT
			,FN_CD_DTL('MAS001',TLM.PL_STAT) AS PL_STAT_NM
			,TLM.PL_REGIST_NO
			,TLM.CON_NUM
			,TLM.CI
			,TLM.PL_M_NAME
			,TLM.PL_M_Z_ID
			,TLM.PL_M_Z_ID_EDU
			,FN_CELLPHONE(TLM.PL_CELLPHONE) AS PL_CELLPHONE
			,TLM.ADDR
			,TLM.ADDR_DETAIL
			,TLM.PL_EDU_NO
			,TLM.CAREER_START_DATE
			,TLM.CAREER_END_DATE
			,TLM.ENTRUST_DATE
			,TO_DATE(TLM.COM_CONT_DATE,'YYYYMMDD') AS COM_CONT_DATE
			,TLM.PL_MERCHANT_NAME
			,TLM.PL_CEO_NAME
			,TLM.PL_MERCHANT_NO
			,TLM.PL_BUSINESS_NO
			,TLM.COMP_PHONE_NO
			,TLM.CORP_FOUND_DATE
			,TLM.CAPITAL
			,TLM.PL_PAY_STAT
			<!-- ,FN_CD_DTL('A0001',TLM.PL_PAY_STAT) AS PL_PAY_STAT_NM -->
			,TLM.COM_REG_DATE
			,TLM.CRE_APP_DATE
			,TLM.CRE_LICENSE_DATE
			,TLM.PAY_DATE
			,TLM.SEND_MSG
			,TLM.PL_HIST_CD
			,TLM.COM_HAEJI_DATE
			,TLM.CRE_HAEJI_DATE
			,TLM.FILE_SEQ
			,TO_CHAR(TLM.REG_TIMESTAMP,'YYYY-MM-DD') AS REG_TIMESTAMP
			,TLM.UPD_SEQ
			,TO_CHAR(TLM.UPD_TIMESTAMP,'YYYY-MM-DD') AS UPD_TIMESTAMP
			,(SELECT NAME FROM TB_LC_PAY WHERE MASTER_SEQ = TLM.MASTER_SEQ) AS PAY_NAME
		FROM TB_LC_MAS01 TLM
		WHERE TLM.MASTER_SEQ	= #{masterSeq}
		AND TLM.PL_STAT 		= '9'						-- 처리상태가 완료인 것
		AND TLM.PL_REG_STAT 	= #{plRegStat}
	</select>
	
   	<!-- 모집인 상태 변경 : 자격취득 -->
	<update id="updatePlRegStat" parameterType="search">
		UPDATE TB_LC_MAS01
		SET
			 PL_REG_STAT 	= #{plRegStat}
			<if test="conNum != null and conNum != ''">
			,CON_NUM 		= #{conNum}		-- 은행연합회 계약번호
			</if> 
			,UPD_SEQ 		= #{updSeq}
			,UPD_TIMESTAMP 	= NOW()
		<where>
			AND MASTER_SEQ 	= #{masterSeq}
		</where>
	</update>
	
	<!-- 모집인 정보 단계별(STATUS) 이력 저장 -->
   	<insert id="insertSearchUserStepHistory" parameterType="search">
   		INSERT INTO TB_LC_MAS01_STEP
   		(
   			 MASTER_SEQ
   			,PL_REG_STAT
   			,PL_STAT
   			,PL_HIST_TXT
   			,REG_TIMESTAMP
   			,REG_SEQ
   		)
   		SELECT
   			 MASTER_SEQ
   			,PL_REG_STAT
   			,PL_STAT
   			,CASE 
				WHEN PL_STAT = '4' THEN FN_CD_DTL('DRP001',PL_HIST_CD)
				WHEN PL_STAT IN ('3','5','6','7','10','11','12') THEN PL_HIST_TXT
				ELSE ''
			 END AS PL_HIST_TXT
   			,NOW()
   			,#{regSeq}
   		FROM TB_LC_MAS01
   		WHERE MASTER_SEQ = #{masterSeq}
   	</insert>
	
	<!-- 위반이력 리스트 -->
	<select id="selectSearchUserViolationInfoList" parameterType="search" resultType="search">
		SELECT
			 VIOLATION_SEQ
			,MASTER_SEQ
			,VIOLATION_CD
			,FN_CD_DTL('VIT001',VIOLATION_CD) AS VIOLATION_CD_NM
			,REG_SEQ
			,TO_CHAR(REG_TIMESTAMP,'YYYY-MM-DD') AS REG_TIMESTAMP
		FROM TB_LC_VIOLATION
		WHERE MASTER_SEQ = #{masterSeq}
	</select>
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
   	
</mapper> 