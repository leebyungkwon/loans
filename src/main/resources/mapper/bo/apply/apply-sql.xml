<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.loanscrefia.admin.apply.repository.ApplyRepository">
   	<!-- 모집인 조회 및 변경 > 리스트 -->
   	<select id="selectApplyList" parameterType="apply" resultType="apply">
   		SELECT 
	    	<include refid="common.totalPages"/>
	    	 TLM.MASTER_SEQ
			,TLM.COM_CODE
			,FN_COM_CODE(TLM.COM_CODE) AS COM_CODE_NM
			,TLM.MEMBER_SEQ
			,FN_MEMBER_NAME(TLM.MEMBER_SEQ) AS MEMBER_NM
			,TLM.PL_CLASS
			,FN_CD_DTL('CLS001',TLM.PL_CLASS) AS PL_CLASS_NM
			,TLM.CAREER_TYP
			,FN_CD_DTL('CAR001',TLM.CAREER_TYP) AS CAREER_TYP_NM
			,TLM.PL_PRODUCT
			,FN_CD_DTL('PRD001',TLM.PL_PRODUCT) AS PL_PRODUCT_NM
			,TLM.PL_REG_STAT
			,FN_CD_DTL('REG001',TLM.PL_REG_STAT) AS PL_REG_STAT_NM
			,TLM.PL_STAT
			,FN_CD_DTL('MAS001',TLM.PL_STAT) AS PL_STAT_NM
			,TLM.PL_REGIST_NO
			,TLM.CI
			,TLM.PL_M_NAME
			,FN_PL_M_Z_ID(TLM.PL_M_Z_ID) AS PL_M_Z_ID
			,TLM.PL_M_Z_ID_EDU
			,FN_CELLPHONE(TLM.PL_CELLPHONE) AS PL_CELLPHONE
			,TLM.ADDR
			,TLM.ADDR_DETAIL
			,TLM.PL_EDU_NO
			,TLM.CAREER_START_DATE
			,TLM.CAREER_END_DATE
			,TLM.ENTRUST_DATE
			,TLM.COM_CONT_DATE
			,TLM.PL_MERCHANT_NAME
			,TLM.PL_CEO_NAME
			,FN_PL_M_Z_ID(TLM.PL_MERCHANT_NO) AS PL_MERCHANT_NO
			,TLM.PL_BUSINESS_NO
			,TLM.COMP_PHONE_NO
			,TLM.CORP_FOUND_DATE
			,TLM.CAPITAL
			,TLM.PL_PAY_STAT
			<!-- ,FN_CD_DTL('A0001',TLM.PL_PAY_STAT) AS PL_PAY_STAT_NM -->
			,TO_DATE(TLM.COM_REG_DATE,'YYYYMMDD') AS COM_REG_DATE
			,TLM.CRE_APP_DATE AS ORIGIN_CRE_APP_DATE
			,TO_DATE(TLM.CRE_APP_DATE,'YYYYMMDD') AS CRE_APP_DATE
			,TLM.CRE_LICENSE_DATE AS ORIGIN_CRE_LICENSE_DATE
			,TO_DATE(TLM.CRE_LICENSE_DATE,'YYYYMMDD') AS CRE_LICENSE_DATE
			,TLM.PAY_DATE AS ORIGIN_PAY_DATE
			,TO_DATE(TLM.PAY_DATE,'YYYYMMDD') AS PAY_DATE
			,TLM.SEND_MSG
			,TLM.PL_HIST_CD
			,TLM.COM_HAEJI_DATE
			,TLM.CRE_HAEJI_DATE
			,TLM.FILE_SEQ
			,TO_CHAR(TLM.REG_TIMESTAMP,'YYYY-MM-DD') AS REG_TIMESTAMP
			,TLM.UPD_SEQ
			,TO_CHAR(TLM.UPD_TIMESTAMP,'YYYY-MM-DD') AS UPD_TIMESTAMP
	    FROM TB_LC_MAS01 TLM
		<where>
			AND TLM.PL_STAT IN ('2','3','4','5','7')													-- 처리상태가 승인요청, 변경요청, 해지요청, 완료건
			
			<if test="comCode != null and comCode != ''">
				AND TLM.COM_CODE = CAST(#{comCode} AS INTEGER)
			</if>		
			
			<if test="plRegStat != null and plRegStat != ''">
				AND TLM.PL_REG_STAT	= #{plRegStat}
			</if>		
			<if test="plStat != null and plStat != ''">
				AND TLM.PL_STAT 	= #{plStat}
			</if>
			<if test="plClass != null and plClass != ''">
				AND TLM.PL_CLASS 	= #{plClass}
			</if>
			<if test="plProduct != null and plProduct != ''">
				AND TLM.PL_PRODUCT 	= #{plProduct}
			</if>

			<if test="plMName != null and plMName != ''">
				AND TLM.PL_M_NAME LIKE '%' || #{plMName} || '%'
			</if>

			<if test="plMZId != null and plMZId != ''">
				AND TLM.PL_M_Z_ID LIKE '%' || #{plMZId} || '%'
			</if>
			
			<if test="plCellphone != null and plCellphone != ''">
				AND TLM.PL_CELLPHONE LIKE '%' || #{plCellphone} || '%'
			</if>

	    	<choose>
   				<when test="srchSelect2 != null and srchSelect2 != ''">
					<if test="srchSelect2.equals('creAppDate')">
						<if test="srchDate1 != null and srchDate1 != ''">
							AND TLM.CRE_APP_DATE::TIMESTAMP <![CDATA[>=]]> #{srchDate1}::TIMESTAMP
						</if>
						<if test="srchDate2 != null and srchDate2 != ''">
							AND TLM.CRE_APP_DATE::TIMESTAMP <![CDATA[<=]]> #{srchDate2}::TIMESTAMP + INTERVAL '1 day'
						</if>
					</if>
					<if test="srchSelect2.equals('payDate')">
						<if test="srchDate1 != null and srchDate1 != ''">
							AND TLM.PAY_DATE::TIMESTAMP <![CDATA[>=]]> #{srchDate1}::TIMESTAMP
						</if>
						<if test="srchDate2 != null and srchDate2 != ''">
							AND TLM.PAY_DATE::TIMESTAMP <![CDATA[<=]]> #{srchDate2}::TIMESTAMP + INTERVAL '1 day'
						</if>
					</if>
					<if test="srchSelect2.equals('creLicenseDate')">
						<if test="srchDate1 != null and srchDate1 != ''">
							AND TLM.CRE_LICENSE_DATE::TIMESTAMP <![CDATA[>=]]> #{srchDate1}::TIMESTAMP
						</if>
						<if test="srchDate2 != null and srchDate2 != ''">
							AND TLM.CRE_LICENSE_DATE::TIMESTAMP <![CDATA[<=]]> #{srchDate2}::TIMESTAMP + INTERVAL '1 day'
						</if>
					</if>
				</when>
			</choose>
	    </where>
	    <include refid="common.pageBottom"/>
   	</select>
   
   	<!-- 모집인 조회 및 변경 > 상세 -->
   	<select id="getApplyDetail" parameterType="apply" resultType="apply">
   		SELECT 
	    	 TLM.MASTER_SEQ
			,TLM.COM_CODE
			,FN_COM_CODE(TLM.COM_CODE) AS COM_CODE_NM
			,TLM.MEMBER_SEQ
			,FN_MEMBER_NAME(TLM.MEMBER_SEQ) AS MEMBER_NM
			,(SELECT EMAIL FROM TB_LC_MEMBERS WHERE MEMBER_SEQ = TLM.MEMBER_SEQ) AS EMAIL
			,FN_CELLPHONE((SELECT MOBILE_NO FROM TB_LC_MEMBERS WHERE MEMBER_SEQ = TLM.MEMBER_SEQ)) AS MOBILE_NO
			,TLM.PL_CLASS
			,FN_CD_DTL('CLS001',TLM.PL_CLASS) AS PL_CLASS_NM
			,TLM.CAREER_TYP
			,FN_CD_DTL('CAR001',TLM.CAREER_TYP) AS CAREER_TYP_NM
			,TLM.PL_PRODUCT
			,FN_CD_DTL('PRD001',TLM.PL_PRODUCT) AS PL_PRODUCT_NM
			,TLM.PL_REG_STAT
			,FN_CD_DTL('REG001',TLM.PL_REG_STAT) AS PL_REG_STAT_NM
			,TLM.PL_STAT
			,FN_CD_DTL('MAS001',TLM.PL_STAT) AS PL_STAT_NM
			,TLM.PL_REGIST_NO
			,TLM.CI
			,TLM.PL_M_NAME
			,FN_PL_M_Z_ID(TLM.PL_M_Z_ID) AS PL_M_Z_ID
			,FN_CELLPHONE(TLM.PL_CELLPHONE) AS PL_CELLPHONE
			,TLM.ADDR
			,FN_CD_DTL('ADD001',TLM.ADDR) AS ADDR_NM
			,TLM.ADDR_DETAIL
			,TLM.PL_EDU_NO
			,TO_DATE(TLM.CAREER_START_DATE,'YYYYMMDD') AS CAREER_START_DATE
			,TO_DATE(TLM.CAREER_END_DATE,'YYYYMMDD') AS CAREER_END_DATE
			,TO_DATE(TLM.ENTRUST_DATE,'YYYYMMDD') AS ENTRUST_DATE
			,TO_DATE(TLM.COM_CONT_DATE,'YYYYMMDD') AS COM_CONT_DATE
			,TLM.PL_MERCHANT_NAME
			,TLM.PL_CEO_NAME
			,TLM.PL_MERCHANT_NO AS ORIGIN_PL_MERCHANT_NO
			,FN_PL_M_Z_ID(TLM.PL_MERCHANT_NO) AS PL_MERCHANT_NO
			,TLM.PL_BUSINESS_NO
			,TLM.COMP_PHONE_NO
			,TO_DATE(TLM.CORP_FOUND_DATE,'YYYYMMDD') AS CORP_FOUND_DATE
			,TLM.CAPITAL
			,TLM.PL_PAY_STAT
			<!-- ,FN_CD_DTL('A0001',TLM.PL_PAY_STAT) AS PL_PAY_STAT_NM -->
			,TLM.COM_REG_DATE
			,TLM.CRE_APP_DATE
			,TLM.CRE_LICENSE_DATE
			,TLM.PAY_DATE
			,TLM.SEND_MSG
			,TLM.PL_HIST_CD
			,TLM.PL_HIST_TXT
			,TLM.COM_HAEJI_DATE
			,TLM.CRE_HAEJI_DATE
			,TLM.FILE_SEQ
			,TO_CHAR(TLM.REG_TIMESTAMP,'YYYY-MM-DD') AS REG_TIMESTAMP
			,TLM.UPD_SEQ
			,TO_CHAR(TLM.UPD_TIMESTAMP,'YYYY-MM-DD') AS UPD_TIMESTAMP
	    FROM TB_LC_MAS01 TLM
	    <where>
	    	AND TLM.MASTER_SEQ = #{masterSeq}
	    </where>
   	</select>
   	
   	<!-- 모집인 조회 및 변경 > 법인 : 대표자 및 임원 상세 -->
   	<select id="selectApplyCorpImwonList" parameterType="applyImwon" resultType="applyImwon">
   		SELECT 
			 EXC_SEQ
			,MASTER_SEQ
			,CAREER_TYP
			,FN_CD_DTL('CAR001',CAREER_TYP) AS CAREER_TYP_NM
			,POSITION_NM
			,EXC_NAME
			,FN_PL_M_Z_ID(PL_M_Z_ID) AS PL_M_Z_ID
			,PL_EDU_NO
			,TO_DATE(CAREER_START_DATE,'YYYYMMDD') AS CAREER_START_DATE
			,TO_DATE(CAREER_END_DATE,'YYYYMMDD') AS CAREER_END_DATE
			,FULL_TM_STAT
			,FN_CD_DTL('FTM001',FULL_TM_STAT) AS FULL_TM_STAT_NM
			,EXPERT_STAT
			,FN_CD_DTL('EXP001',EXPERT_STAT) AS EXPERT_STAT_NM
			,FILE_SEQ
   		FROM TB_LC_MAS01_IMWON
   		<where>
   			AND MASTER_SEQ = #{masterSeq}
   		</where>
   		ORDER BY EXC_SEQ ASC
   	</select>
   	
   	<!-- 모집인 조회 및 변경 > 법인 : 전문인력 상세 -->
   	<select id="selecApplyCorpExpertList" parameterType="applyExpert" resultType="applyExpert">
   		SELECT
			 EXP_SEQ
			,MASTER_SEQ
			,CAREER_TYP
			,FN_CD_DTL('CAR001',CAREER_TYP) AS CAREER_TYP_NM
			,EXP_NAME
			,FN_PL_M_Z_ID(PL_M_Z_ID) AS PL_M_Z_ID
			,PL_EDU_NO
			,TO_DATE(CAREER_START_DATE,'YYYYMMDD') AS CAREER_START_DATE
			,TO_DATE(CAREER_END_DATE,'YYYYMMDD') AS CAREER_END_DATE
			,FILE_SEQ
   		FROM TB_LC_MAS01_EXPERT
   		<where>
   			AND MASTER_SEQ = #{masterSeq}
   		</where>
   		ORDER BY EXP_SEQ ASC
   	</select>
   	
   	<!-- 모집인 조회 및 변경 > 법인 : 전산인력 상세 -->
   	<select id="selectApplyCorpItList" parameterType="applyIt" resultType="applyIt">
   		SELECT
	   		 OPER_SEQ
			,MASTER_SEQ
			,OPER_NAME
			,FN_PL_M_Z_ID(PL_M_Z_ID) AS PL_M_Z_ID
			,FILE_SEQ
   		FROM TB_LC_MAS01_IT
   		<where>
   			AND MASTER_SEQ = #{masterSeq}
   		</where>
   		ORDER BY OPER_SEQ ASC
   	</select>
   	
   	
   	<!-- 모집인 조회 및 변경 > 승인처리 -->
   	<update id="updateApplyPlStat" parameterType="applyIt">
   		UPDATE tb_lc_mas01
   		SET
   			pl_stat = #{plStat}
   			<if test="plRegStat != null and plRegStat != ''">
   				, pl_reg_stat = #{plRegStat}
   			</if>
   			<if test="plRegStat != null and plRegStat != ''">
   				, cre_app_date = TO_CHAR(NOW(), 'YYYYMMDD')
   			</if>
   			<if test="plHistTxt != null and plHistTxt != ''">
   				,pl_hist_txt = #{plHistTxt}
   			</if>
   			<if test="plStat == '5' ">
   				,com_reg_date = TO_CHAR(NOW(), 'YYYYMMDD')
   			</if>
   			, upd_seq = #{updSeq}
   			, upd_timestamp = NOW()
   		WHERE
   			master_seq = #{masterSeq}
   	</update>
   	
   	
   	<insert id="insertMasterStep" parameterType="apply">
   		INSERT INTO TB_LC_MAS01_STEP
   		(
   			 MASTER_SEQ
   			,PL_REG_STAT
   			,PL_STAT
   			,PL_HIST_TXT
   			,REG_TIMESTAMP
   			,REG_SEQ
   		)
   		SELECT
   			 MASTER_SEQ
   			,PL_REG_STAT
   			,PL_STAT
   			,PL_HIST_TXT
   			,NOW()
   			,#{regSeq}
   		FROM TB_LC_MAS01
   		WHERE MASTER_SEQ = #{masterSeq}
   	</insert>
   	
   	
</mapper> 