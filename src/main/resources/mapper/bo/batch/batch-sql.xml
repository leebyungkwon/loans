<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.loanscrefia.system.batch.repository.BatchRepository">

	<!-- 모집인 엑셀 업로드 후 1개월동안 처리상태가 미요청 + 모집인상태가 승인전인 경우 -> 모집인 데이터 및 모집인 관련 첨부파일 삭제 -->
    <select id="selectExcelUploadUserAndFileDelete" resultType="user">
		SELECT
			 MASTER_SEQ 
		FROM TB_LC_MAS01
		WHERE PL_STAT 	= '1'	-- 처리상태 	: 미요청
		AND PL_REG_STAT = '1'	-- 모집인상태 	: 승인전
		AND TO_CHAR(REG_TIMESTAMP + INTERVAL '1 month', 'YYYYMMDD') <![CDATA[>=]]> TO_CHAR(NOW(), 'YYYYMMDD')
    </select>
    
   	<!-- 마지막로그인일시 기준 3개월 지난 회원 리스트 -->
   	<select id="selectInactiveUser" parameterType="users" resultType="users">
   		SELECT
   			USER_SEQ
   		FROM
   			tb_lc_users
   		WHERE
   			(last_login_dt + '3 month'::interval) <![CDATA[<=]]> now()
   	</select>
   	
    <select id="selectReqBatchList" resultType="recreg">
		SELECT
			 MASTER_SEQ 
		FROM TB_LC_MAS01
		WHERE PL_STAT 	= '9'	
		AND PL_REGIST_NO IS NULL
    </select>
    
    
    <select id="selectBatchList" parameterType="batch" resultType="batch">
    	SELECT
    		*
    	FROM
    		tb_lc_schedule
    	WHERE schedule_name = #{scheduleName}
    </select>
    
    <!-- 스케줄러 테이블 상태변경 --> 
    <update id="updateSchedule" parameterType="batch" >
		update tb_lc_schedule
		set
			status = #{status}
			<if test="error != null and error != ''">
			, error = #{error}
			</if>
			, upd_seq = 0
			, upd_timestamp = NOW()
		where schedule_seq = #{scheduleSeq}
    </update>
    
    
    <!-- 가등록번호 update --> 
    <update id="updatePreloanReg" parameterType="newApply" >
		update tb_lc_mas01
		set
			pre_lc_num = #{preLcNum}
			, upd_timestamp = NOW()
			, upd_seq = #{regSeq}
		where
			master_seq = #{masterSeq}
    </update>
    
    
   	
    
</mapper>