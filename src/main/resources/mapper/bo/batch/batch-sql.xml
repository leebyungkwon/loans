<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.loanscrefia.system.batch.repository.BatchRepository">

	<!-- 모집인 엑셀 업로드 후 1개월동안 처리상태가 미요청 + 모집인상태가 승인전인 경우 -> 모집인 데이터 및 모집인 관련 첨부파일 삭제 -->
    <select id="selectExcelUploadUserAndFileDelete" resultType="user">
		SELECT
			 MASTER_SEQ 
		FROM TB_LC_MAS01
		WHERE PL_STAT 	= '1'	-- 처리상태 	: 미요청
		AND PL_REG_STAT = '1'	-- 모집인상태 	: 승인전
		AND TO_CHAR(REG_TIMESTAMP + INTERVAL '1 month', 'YYYYMMDD') <![CDATA[>=]]> TO_CHAR(NOW(), 'YYYYMMDD')
    </select>
    
   	<!-- 마지막로그인일시 기준 3개월 지난 회원 리스트 -->
   	<select id="selectInactiveUser" parameterType="users" resultType="users">
   		SELECT
   			USER_SEQ
   		FROM
   			tb_lc_users
   		WHERE
   			(last_login_dt + '3 month'::interval) <![CDATA[<=]]> now()
   	</select>
   	
    <select id="selectReqBatchList" resultType="recreg">
		SELECT
			 MASTER_SEQ 
		FROM TB_LC_MAS01
		WHERE PL_STAT 	= '9'	
		AND PL_REGIST_NO IS NULL
    </select>
    
    
    

	<!-- 배치 예정건 등록 -->
   	<insert id="insertBatchPlanInfo" parameterType="batch">
   		INSERT INTO TB_LC_SCHEDULE
   		(
	   		 SCHEDULE_NAME 
			,PARAM 
			,REG_TIME 
			,STATUS 
			,PROPERTY01
			,REG_SEQ 
			,REG_TIMESTAMP
   		)
   		VALUES
   		(
	   		 #{scheduleName}
			,#{param}
			,NOW()
			,'1'
			,#{property01}
			,#{regSeq}
			,NOW()
   		)
   	</insert>
    
    
    
    <select id="selectBatchList" parameterType="batch" resultType="batch">
    	SELECT
    		*
    	FROM
    		tb_lc_schedule
    	WHERE schedule_name = #{scheduleName}
    	AND status in ('01', '03')
    </select>
    
    <!-- 2021-11-11 해지신청 리스트 조회 -->
    <select id="selectDropApplyList" parameterType="batch" resultType="newApply">
		select
			MASTER_SEQ
			, CON_NUM
			, COM_CODE
			, FN_CELLPHONE(PL_CELLPHONE) AS PL_CELLPHONE
			, PL_CLASS
			, PL_PRODUCT
			, PL_REG_STAT
			, PL_STAT
			, PL_REGIST_NO
			, CI
			, PL_M_NAME
			, PL_M_Z_ID
			, COM_CONT_DATE
			, PL_MERCHANT_NAME
			, PL_CEO_NAME
			, PL_MERCHANT_NO
			, PL_BUSINESS_NO
			, COMP_PHONE_NO
			, PL_HIST_CD
			, COM_HAEJI_DATE
			, TO_CHAR(NOW(), 'YYYYMMDD') as CRE_HAEJI_DATE
		from
			tb_lc_mas01
		where
			PL_STAT = '4'
		and com_haeji_date <![CDATA[<=]]> TO_CHAR(TO_CHAR(NOW(), 'YYYYMMDD')::TIMESTAMP - INTERVAL '4 day', 'YYYYMMDD')
    </select>
    
    
    <!-- 스케줄러 테이블 상태변경 --> 
    <update id="updateSchedule" parameterType="batch" >
		update tb_lc_schedule
		set
			status = #{status}
			<if test="error != null and error != ''">
				, error = #{error}
			</if>
			, upd_seq = 0
			, upd_timestamp = NOW()
		where schedule_seq = #{scheduleSeq}
    </update>
    
    
    <!-- 계약정보(가등록번호, 등록번호 추가) update --> 
    <update id="updatePreLcNum" parameterType="newApply" >
		update tb_lc_mas01
		set
			pre_lc_num 		= #{preLcNum}
			, pl_regist_no	= #{plRegistNo}
			, con_num		= #{conNum}
			, upd_timestamp = NOW()
			, upd_seq 		= 0
			, pl_reg_stat	= '3'
			, pl_stat		= '9'
			, cre_license_date = TO_CHAR(NOW(), 'YYYYMMDD')
		where
			master_seq = #{masterSeq}
    </update>
    
    <!-- 배치 시작 이력 저장 -->
    <select id="insertScheduleHist" parameterType="batch" resultType="int">
		INSERT INTO tb_lc_schedule_hist
		(
			schedule_name
			, req_cnt
			, start_time
			<if test="property01 != null and property01 != ''">
				, property01
			</if>
			<if test="property02 != null and property02 != ''">
				, property02
			</if>
			<if test="property03 != null and property03 != ''">
				, property03
			</if>
			<if test="property04 != null and property04 != ''">
				, property04
			</if>
			<if test="property05 != null and property05 != ''">
				, property05
			</if>
			, reg_seq
			, reg_timestamp
		)
		VALUES(
			#{scheduleName}
			, #{reqCnt}
			, NOW()
			<if test="property01 != null and property01 != ''">
				, #{property01}
			</if>
			<if test="property02 != null and property02 != ''">
				, #{property02}
			</if>
			<if test="property03 != null and property03 != ''">
				, #{property03}
			</if>
			<if test="property04 != null and property04 != ''">
				, #{property04}
			</if>
			<if test="property05 != null and property05 != ''">
				, #{property05}
			</if>
			, 0
			, NOW()
		)
		RETURNING schedule_hist_seq AS scheduleHistSeq
    </select>
   	
    <!-- 배치 종료 이력 저장 --> 
    <update id="updateScheduleHist" parameterType="batch" >
		UPDATE tb_lc_schedule_hist
		SET
			success_cnt			= #{successCnt}
			, end_time			= NOW()
			<if test="property01 != null and property01 != ''">
				, property01	= #{property01}
			</if>
			<if test="property02 != null and property02 != ''">
				, property02	= #{property02}
			</if>
			<if test="property03 != null and property03 != ''">
				, property03	= #{property03}
			</if>
			<if test="property04 != null and property04 != ''">
				, property04	= #{property04}
			</if>
			<if test="property05 != null and property05 != ''">
				, property05	= #{property05}
			</if>
			, upd_seq			= 0
			, upd_timestamp		= NOW()
		WHERE
			schedule_name = #{scheduleName}
		AND schedule_hist_seq = #{scheduleHistSeq}
    </update>
    
    
    <!-- 해지완료 후 상태변경 --> 
    <update id="updateDropApply" parameterType="newApply" >
		update tb_lc_mas01
		set
			pl_stat 			= '9'
			, pl_reg_stat		= '4'
			, cre_haeji_date	= TO_CHAR(TO_CHAR(NOW(), 'YYYYMMDD')
			, upd_timestamp 	= NOW()
			, upd_seq 			= 0
		where
			master_seq = #{masterSeq}
    </update>
    
    <!-- 개인회원 계약정보변경 완료 --> 
    <update id="updateIndvMasInfo" parameterType="newApply" >
		update tb_lc_mas01
		set
			pl_m_name 			= #{plMName}
			, pl_cellphone		= #{plCellphone}
			, upd_timestamp 	= NOW()
			, upd_seq 			= 0
		where
			master_seq = #{masterSeq}
    </update>
    
    <!-- 법인회원 계약정보변경 완료 --> 
    <update id="updateCorpMasInfo" parameterType="newApply" >
		update tb_lc_mas01
		set
			pl_ceo_name 		= #{plCeoName}
			, pl_merchant_name	= #{plMerchantName}
			, pl_m_z_id			= #{plMZId};
			, ci				= #{ci}
			, upd_timestamp 	= NOW()
			, upd_seq 			= 0
		where
			master_seq = #{masterSeq}
    </update>
    
    <!-- 개인회원 회원정보 수정 --> 
    <update id="updateIndvUsersInfo" parameterType="newApply" >
		update tb_lc_users
		set
			USER_NAME 			= #{userName}
			, MOBILE_NO 		= #{mobileNo}
			, upd_timestamp 	= NOW()
			, upd_seq 			= 0
		where USER_SEQ 	= #{userSeq}
    </update>
    
    <!-- 법인회원 회원정보 수정 --> 
    <update id="updateIndvUsersInfo" parameterType="newApply" >
		update tb_lc_users
		set
			USER_NAME 			= #{userName}
			, MOBILE_NO 		= #{mobileNo}
			, PL_M_Z_ID			= #{plMZId}
			, USER_CI			= #{userCi}
			, upd_timestamp 	= NOW()
			, upd_seq 			= 0
		where USER_SEQ 	= #{userSeq}
    </update>
    
    <!-- 법인정보 수정 --> 
    <update id="updateCorpInfo" parameterType="newApply" >
		update tb_lc_corp
		set
			PL_MERCHANT_NAME 	= #{plMerchantName}
			, upd_timestamp 	= NOW()
			, upd_seq 			= 0
		where USER_SEQ 	= #{userSeq}
    </update>
    
    
	<!-- 위반이력 수정 -->
	<insert id="updateUserViolationInfo" parameterType="newUser">
		UPDATE TB_LC_VIOLATION
		SET
			VIO_NUM = #{vioNum}
		WHERE
			VIOLATION_SEQ = #{violationSeq}
	</insert>
    
    
</mapper>