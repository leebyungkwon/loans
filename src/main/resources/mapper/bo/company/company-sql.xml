<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.loanscrefia.admin.company.repository.CompanyRepository">

	<!-- 회원사 담당자 조회  -->
    <select id="selectCompanyList" parameterType="company" resultType="company">
	    SELECT 
	    	<include refid="common.totalPages"/>
    		 TLM.MEMBER_SEQ
			,TLM.MEMBER_ID
			,TLM.PASSWORD
			,TLM.COM_CODE
			,fn_com_code(TLM.COM_CODE) AS COM_CODE_NM
			,TLM.MEMBER_NAME
			,TLM.EMAIL
			<!--,TLM.EXTENSION_NO -->
      	    ,REGEXP_REPLACE(TLM.EXTENSION_NO, '(02|031|032|033|041|042|043|051|052|053|054|055|061|062|063|064'||'|010|011|016|017|018|019'||'|030|050|060|070|080)'||'(.+)(.{4})','\1-\2-\3') AS extensionNo
    		<!--,TLM.MOBILE_NO -->
      		,REGEXP_REPLACE(TLM.MOBILE_NO, '(02|.{3})(.+)(.{4})', '\1-\2-\3') AS mobileNo
			,TLM.DEPT_NM
			,TLM.POSITION_NM
			,TO_DATE(TLM.JOIN_DT, 'YYYYMMDD') AS joinDt
			,TLM.ROLE_NAME
			,TLM.TERMS_YN
			,TLM.TERMS_DATE
			,TLM.APPR_STAT
			<!-- ,fn_appr_stat(TLM.APPR_STAT) AS APPR_STAT_NM -->
			,TLM.FILE_SEQ
			,TLM.FAIL_CNT
			,TLM.CRE_YN
			,TLM.DROP_YN
			,TLM.UPD_SEQ
			,TLM.UPD_TIMESTAMP
	    FROM TB_LC_MEMBERS TLM
	    <where>
	    	<if test="comCode != 0 and comCode != '0'">
				AND	TLM.COM_CODE 	    = #{comCode}
			</if>
			<if test="apprStat != null and apprStat != ''">
				AND	TLM.APPR_STAT 		= #{apprStat}
			</if>
		</where>
	    <include refid="common.pageBottom"/>
    </select>
    
   <!-- 회원사 담당자 상세보기 -->
	<select id="getCompanyDetail" parameterType="company" resultType="company">
		SELECT 
    		 TLM.MEMBER_SEQ
			,TLM.MEMBER_ID
			,TLM.PASSWORD
			,TLM.COM_CODE
			,fn_com_code(TLM.COM_CODE) AS COM_CODE_NM
			,TLM.MEMBER_NAME
			,TLM.EMAIL
			<!--,TLM.EXTENSION_NO -->
     	    ,REGEXP_REPLACE(TLM.EXTENSION_NO, '(02|031|032|033|041|042|043|051|052|053|054|055|061|062|063|064'||'|010|011|016|017|018|019'||'|030|050|060|070|080)'||'(.+)(.{4})','\1-\2-\3') AS extensionNo
			<!--,TLM.MOBILE_NO -->
     	    ,REGEXP_REPLACE(TLM.MOBILE_NO, '(02|.{3})(.+)(.{4})', '\1-\2-\3') AS mobileNo
			,TLM.DEPT_NM
			,TLM.POSITION_NM
			,TO_DATE(TLM.JOIN_DT, 'YYYYMNDD') AS joinDt
			,TLM.ROLE_NAME
			,TLM.TERMS_YN
			,TLM.TERMS_DATE
			,TLM.APPR_STAT
			<!-- ,fn_appr_stat(TLM.APPR_STAT) AS APPR_STAT_NM -->
			,TLM.FILE_SEQ
			,TLM.FAIL_CNT
			,TLM.CRE_YN
			,TLM.DROP_YN
			,TLM.UPD_SEQ
			,TLM.UPD_TIMESTAMP
		FROM TB_LC_MEMBERS TLM
		<where>
			AND MEMBER_SEQ = #{memberSeq}
		</where>
	</select>
	
	<!-- 회원사 담당자 승인 상태 수정 -->
    <update id="updateCompanyStat" parameterType="company">
   		UPDATE TB_LC_MEMBERS
   		SET	
   			 APPR_STAT = #{apprStat}
   			,ROLE_NAME = #{roleName}
   			,UPD_SEQ   = #{updSeq}
   		<where>
   			AND MEMBER_SEQ 	= #{memberSeq}
   		</where>
   	</update>
   	
    <!-- 회원사 담당자 삭제 -->
   	<delete id="deleteCompany" parameterType="company">
   		DELETE FROM TB_LC_MEMBERS
   		<where>
   			AND MEMBER_SEQ 	= #{memberSeq}
   		</where>
   	</delete>
   	
   	<!-- ============== 회원사 관리 테이블 =====================-->
   	
	<!-- 회원사 관리 조회  -->
	<select id="selectCompanyCodeList" parameterType="company" resultType="company">
		SELECT 
		<include refid="common.totalPages"/>
			TLC.COM_CODE
			,TLC.COM_NAME
		<!-- ,TLC.PL_MERCHANT_NO -->
			,REGEXP_REPLACE(TLC.PL_MERCHANT_NO, '(\d{6})(\d{7})', '\1-\2') AS plMerchantNo
		<!-- ,TLC.PL_BUSINESS_NO -->
			,REGEXP_REPLACE(TLC.PL_BUSINESS_NO, '(\d{3})(\d{2})(\d{5})', '\1-\2-\3') AS plBusinessNo
			,TLC.COMP_PHONE_NO
		FROM TB_LC_COMPANY TLC
		<where>
				AND TLC.DEL_YN = 'N'
			<if test="comCode != 0 and comCode != '0'">
				,AND	TLC.COM_CODE 	    = #{comCode}
			</if>
		</where>
		<include refid="common.pageBottom"/>
	</select>
	
	<!-- 회원사 관리 상세 조회 -->
	<select id="getCompanyCodeDetail" parameterType="company" resultType="company">
		SELECT 
			TLC.COM_CODE
			,TLC.COM_NAME
			,TLC.PL_MERCHANT_NO
			,TLC.PL_BUSINESS_NO
			,TLC.COMP_PHONE_NO
		FROM TB_LC_COMPANY TLC
		<where>
			AND TLC.COM_CODE = #{comCode}
		</where>
	</select>
	
	<!-- 회원사 관리 등록  --> 
	<select id="saveCompanyCodeDetail" parameterType="company" resultType="company">
		INSERT INTO TB_LC_COMPANY
			(
				COM_NAME						/*회원사(상호명)*/
				,PL_MERCHANT_NO				/*법인등록번호*/
				,PL_BUSINESS_NO				/*사업자등록번호*/
				,COMP_PHONE_NO				/*회사대표번호*/
				,REG_TIMESTAMP				/*등록일시*/
				,REG_SEQ							/*등록자 시퀀스*/
			)
		VALUES
			(
				#{comName}						/*회원사(상호명)*/      
				,#{plMerchantNo}				/*법인등록번호*/            
				,#{plBusinessNo}					/*사업자등록번호*/         
				,#{compPhoneNo}				/*회사대표번호*/            
				,NOW()								/*등록일시*/           
				,#{regSeq}							/*등록자 시퀀스*/   
			)	
	</select>
	
	<!-- 회원사 관리 수정  -->
	<select id="updCompanyCodeDetail" parameterType="company" resultType="company">
		UPDATE TB_LC_COMPANY
		SET 
			UPD_TIMESTAMP		= NOW()							/*수정일시*/ 
			,UPD_SEQ					= #{updSeq}						/*수정자 시퀀스*/ 
			<if test="comName != null and comName != ''">
				 ,COM_NAME				= #{comName}					/*회원사(상호명)*/  
			 </if>
 			<if test="plMerchantNo != null and plMerchantNo != ''">
				,PL_MERCHANT_NO		= #{plMerchantNo}				/*법인등록번호*/ 
			</if>
 			<if test="plBusinessNo != null and plBusinessNo != ''">			
				,PL_BUSINESS_NO		= #{plBusinessNo}				/*사업자등록번호*/
			</if>
 			<if test="compPhoneNo != null and compPhoneNo != ''">			
				,COMP_PHONE_NO		= #{compPhoneNo}				/*회사대표번호*/ 
			</if>
		<where>
			AND COM_CODE			= #{comCode}
		</where>
	</select>
	
	<!-- 회원사 관리 삭제  -->
	<select id="delCompanyCodeDetail" parameterType="company" resultType="company">
		UPDATE TB_LC_COMPANY
		SET 
			DEL_YN	= 'Y'
		<where>
			AND COM_CODE	=	#{comCode}
		</where>
	</select>
	
	<!-- 회원사 관리 중복 체크 -->
	<select id="plMerchantNoCheck" parameterType="company" resultType="int">
        SELECT count(*)
        FROM TB_LC_COMPANY
        WHERE pl_business_no != (select pl_business_no from tb_lc_company b where b.COM_CODE = #{comCode})
        AND pl_business_no = #{plBusinessNo}
    </select>

</mapper>